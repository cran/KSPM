<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Catherine Schramm, Aurelie Labbe, Celia Greenwood" />

<meta name="date" content="2020-08-08" />

<title>KSPM: an R package for Kernel Semi-Prametric Models</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">KSPM: an R package for Kernel Semi-Prametric Models</h1>
<h4 class="author">Catherine Schramm, Aurelie Labbe, Celia Greenwood</h4>
<h4 class="date">2020-08-08</h4>



<style>
body {
text-align: justify}
</style>
<p> </p>
<p>The <strong>KSPM</strong> package was implemented to fit the single and multiple kernel semi-parametric models for continuous outcome. The package includes the most popular kernel functions, allows kernel interactions and test of variance for each kernel part. The <strong>summary()</strong>, <strong>plot()</strong> and <strong>predict()</strong> commands are available and are similar to those included in standard regression packages. We added a graphical tool for the interpretation of individual effect of variables based on pointwise derivatives. Finally, a variable selection procedure is implemented for the single kernel semi-parametric model.</p>
<p>Some key theoretical details are given in the first section. Then, two examples illustrate how to use the package. The first example is about prediction of movie ratings according to conventional and social media features. The second example is a temporal set of data on energy consumption and meteorology.</p>
<p> </p>
<p>Note that the <strong>KSPM</strong> package depends on <strong>CompQuadForm</strong>, <strong>expm</strong> and <strong>DEoptim</strong> packages that should be installed before the importation of <strong>KSPM</strong> via <strong>library()</strong> command.</p>
<p> </p>
<div id="key-theoretical-details" class="section level1">
<h1><span class="header-section-number">1</span> Key theoretical details</h1>
<div id="the-model" class="section level2">
<h2><span class="header-section-number">1.1</span> The model</h2>
<div id="single-kernel-semi-parametric-model" class="section level3">
<h3><span class="header-section-number">1.1.1</span> Single kernel semi-parametric model</h3>
<p>Let <span class="math inline">\(Y = (Y_1, ..., Y_n)^T\)</span> be a <span class="math inline">\(n \times 1\)</span> vector of continuous outcomes where <span class="math inline">\(Y_i\)</span> is the value for subject <span class="math inline">\(i = 1, ..., n\)</span>, and <span class="math inline">\(X\)</span> and <span class="math inline">\(Z\)</span> are <span class="math inline">\(n \times p\)</span> and <span class="math inline">\(n \times q\)</span> matrices of predictors, such that <span class="math inline">\(Y\)</span> depends on <span class="math inline">\(X\)</span> and <span class="math inline">\(Z\)</span> as follows:</p>
<p><span class="math display">\[Y = X\beta + h(Z) + e\]</span></p>
<p>where <span class="math inline">\(\beta\)</span> is a <span class="math inline">\(p \times 1\)</span> vector of regression coefficients for the linear parametric part, <span class="math inline">\(h(.)\)</span> is an unknown smooth function and <span class="math inline">\(e\)</span> is an <span class="math inline">\(n \times 1\)</span> vector of independent and homoscedastic errors such as <span class="math inline">\(e_i \sim \mathcal{N}(0, \sigma^2)\)</span>. <span class="math inline">\(X\beta\)</span> is referred to as the linear part of the model and we assume that <span class="math inline">\(X\)</span> contains an intercept. <span class="math inline">\(h(Z)\)</span> is referred to as the kernel part. The function <span class="math inline">\(h(.)\)</span> lies in <span class="math inline">\(\mathcal{H}_k\)</span>, the function space generated by a kernel function <span class="math inline">\(k(.,.)\)</span>. <span class="math inline">\(K\)</span> is the <span class="math inline">\(n \times n\)</span> Gram matrix of <span class="math inline">\(k(.,.)\)</span> such that <span class="math inline">\(K_{ij} = k(Z_i, Z_j)\)</span> represents the similarity between subjects <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> according to <span class="math inline">\(Z\)</span>. In the estimation process, <span class="math inline">\(h()\)</span> is expressed as a linear combination of <span class="math inline">\(k(.,.)\)</span> such that:</p>
<p><span class="math display">\[h = K \alpha\]</span></p>
</div>
<div id="multiple-kernel-semi-parametric-model" class="section level3">
<h3><span class="header-section-number">1.1.2</span> Multiple kernel semi-parametric model</h3>
<p>Now suppose there are <span class="math inline">\(L\)</span> matrices <span class="math inline">\(Z_1, ..., Z_L\)</span> of dimension <span class="math inline">\(n \times q_1\)</span>, …, <span class="math inline">\(n \times q_L\)</span>, respectively. Keeping a similar notation, <span class="math inline">\(Y\)</span> can be assumed to depend on <span class="math inline">\(X\)</span> and <span class="math inline">\(Z_1\)</span>, …, <span class="math inline">\(Z_L\)</span> as follows:</p>
<p><span class="math display">\[Y = X\beta + \sum\limits_{\ell = 1}^L h_{\ell}(Z_{\ell}) + e\]</span></p>
<p>where <span class="math inline">\(\forall \ell \in \left\lbrace 1, ..., L \right\rbrace\)</span>, each <span class="math inline">\(h_{\ell}\)</span> is an unknown smooth function from <span class="math inline">\(\mathcal{H}_{k_{\ell}}\)</span>, the function space generated by a kernel function <span class="math inline">\(k_{\ell}(.,.)\)</span> whose Gram matrix is noted <span class="math inline">\(K_{\ell}\)</span>.</p>
</div>
<div id="kernel-interactions" class="section level3">
<h3><span class="header-section-number">1.1.3</span> Kernel interactions</h3>
<p>Suppose there exists an interaction between two sets of variables <span class="math inline">\(Z_1\)</span> and <span class="math inline">\(Z_2\)</span>, <span class="math inline">\(n \times q_1\)</span> and <span class="math inline">\(n \times q_2\)</span> matrices. We assume that <span class="math inline">\(Y\)</span> depends on <span class="math inline">\(X\)</span>, <span class="math inline">\(Z_1\)</span> and <span class="math inline">\(Z_2\)</span> as follows:</p>
<p><span class="math display">\[Y = X\beta + h_1(Z_1) + h_2(Z_2) + h_{12}(Z_1, Z_2) + e\]</span></p>
<p>where <span class="math inline">\(h_1(.)\)</span>, <span class="math inline">\(h_2(.)\)</span> and <span class="math inline">\(h_{12}(.,.)\)</span> are unknown smooth functions from <span class="math inline">\(\mathcal{H}_{k_1}\)</span>, <span class="math inline">\(\mathcal{H}_{k_2}\)</span> and <span class="math inline">\(\mathcal{H}_{k_{12}}\)</span> respectively. The <span class="math inline">\(h_{12}(.,.)\)</span> function represents the interaction term. Its associated kernel function <span class="math inline">\(k_{12}(.,.)\)</span> is defined as the product of kernel functions <span class="math inline">\(k_1(.,.)\)</span> and <span class="math inline">\(k_2(.,.)\)</span>. Obviously, this 2-way interaction model could be generalized to higher order interaction terms.</p>
</div>
</div>
<div id="kernel-functions" class="section level2">
<h2><span class="header-section-number">1.2</span> Kernel functions</h2>
<p>Below is the list of all kernel functions suported in this package, where <span class="math inline">\((i,j)\)</span> represents a pair of subjects with covariates <span class="math inline">\(Z_i\)</span> and <span class="math inline">\(Z_j\)</span>, respectively:</p>
<ul>
<li>Linear kernel function: <span class="math inline">\(k(Z_i, Z_j) = Z_i^T Z_j\)</span></li>
<li>Polynomial kernel function: <span class="math inline">\(k(Z_i, Z_j) = (\rho \, Z_i^T Z_j + \gamma)^d\)</span></li>
<li>Gaussian kernel function: <span class="math inline">\(k(Z_i, Z_j) = exp(-\parallel Z_i - Z_j\parallel^2 / \rho) \; \rho &gt; 0\)</span></li>
<li>Sigmoid kernel function: <span class="math inline">\(k(Z_i, Z_j) = tanh(\rho \, Z_i^T Z_j + \gamma)\)</span></li>
<li>Inverse quadratic kernel function: <span class="math inline">\(k(Z_i, Z_j) = (\parallel Z_i - Z_j\parallel^2 + \gamma)^{-1/2}\)</span></li>
<li>Equality kernel function: <span class="math inline">\(k(Z_i, Z_j) = 1 \; \text{if} \; Z_i = Z_j \; \text{and} \; 0 \; \text{otherwise}\)</span>.</li>
</ul>
<p>Of note, users can define their own kernel functions by providing the corresponding kernel Gram matrices.</p>
<p>Kernel functions involve tuning parameters, noted <span class="math inline">\(\rho\)</span> and <span class="math inline">\(\gamma\)</span> above. In practice, these tuning parameters are chosen by the user or estimated by the package.</p>
</div>
<div id="estimation-of-parameters" class="section level2">
<h2><span class="header-section-number">1.3</span> Estimation of parameters</h2>
<p>The parameter estimates are obtained by maximizing the penalized log-likelihood associated with the kernel semi-parametric model. Penalisation and tuning parameters are estimated by minimizing the leave-one-out error. Estimated parameters are:</p>
<ul>
<li><span class="math inline">\(\beta\)</span>: linear regression coefficients</li>
<li><span class="math inline">\(\alpha_{\ell}\)</span>: kernel regression coefficients (<span class="math inline">\(\ell \in \left\lbrace 1,..,L \right\rbrace\)</span>)</li>
<li><span class="math inline">\(\lambda_{\ell}\)</span>: penalisation parameters (<span class="math inline">\(\ell \in \left\lbrace 1,..,L \right\rbrace\)</span>)</li>
<li><span class="math inline">\(\rho, \gamma\)</span>: tuning parameters if needed (optional for each kernel)</li>
</ul>
</div>
<div id="tests-of-hypotheses-in-kspm" class="section level2">
<h2><span class="header-section-number">1.4</span> Tests of hypotheses in KSPM</h2>
<p>For either a single kernel or a multiple kernel semi-parametric model, a standard test of interest is <span class="math inline">\(H_0: h_{\ell}(.) = 0\)</span>, ie. there is no effect, singly or jointly, of a set of variables on the outcome. If interest lies in a global test for multiple kernel semi-parametric models, the null hypothesis is <span class="math inline">\(H_0: h_1(.) = ... = h_L(.) = 0\)</span>. Both tests are available in the package. They consist in score test for variance component in the equivalent linear mixed effect model.</p>
</div>
<div id="interpretation-of-variable-effects-through-derivatives" class="section level2">
<h2><span class="header-section-number">1.5</span> Interpretation of variable effects through derivatives</h2>
<p>A kernel represents similarity between subjects through combining a set of variables in a possible complex way, that may include their possible interactions. Hence, the general effect of a kernel on an outcome is hard to see and difficult to interpret. Nevertheless, the marginal effect of each variable in the kernel may be illustrated using a partial derivative function. Indeed, the derivative measures how the change in a variable of interest impacts the outcome in an intuitively understandable way.</p>
<p> </p>
</div>
</div>
<div id="example-movie-ratings-dataset" class="section level1">
<h1><span class="header-section-number">2</span> Example: movie ratings dataset</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(KSPM)</a></code></pre></div>
<div id="data-importation" class="section level2">
<h2><span class="header-section-number">2.1</span> Data importation</h2>
<p>The conventional and social media movies (csm) dataset contains data on 187 movies from 2014 and 2015. To predict ratings, movies are described using a set of 6 variables called conventional features (genre, sequel, budget in USD, gross income in USD, number of screens in USA) and another set of 6 variables called social media features (aggregate actor followers on Twitter, number of views, likes, dislikes, comments of movie trailer on Youtube, sentiment score). The dataset may be loaded from the package using the <strong>data()</strong> command. This data set is a subset of the one available on the UCI machine learning repository (<a href="https://archive.ics.uci.edu/ml/index.php" class="uri">https://archive.ics.uci.edu/ml/index.php</a>) and fully described in Ahmed <em>et al.</em> (2015).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">data</span>(csm) </a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">head</span>(csm)</a></code></pre></div>
</div>
<div id="predicting-ratings-using-the-set-of-conventional-features" class="section level2">
<h2><span class="header-section-number">2.2</span> Predicting ratings using the set of conventional features</h2>
<div id="fitting-the-model" class="section level3">
<h3><span class="header-section-number">2.2.1</span> Fitting the model</h3>
<p>The model is fitted using the <strong>kspm()</strong> command. Its principal arguments are:</p>
<ul>
<li><strong>response</strong>: outcome variable (ratings in our example)</li>
<li><strong>linear</strong>: linear covariates (in our example, no linear term is specified by the user and only an intercept is included in the linear part of the model)</li>
<li><strong>kernel</strong>: kernel covariates (in our example: the set of conventional features)</li>
<li><strong>data</strong>: dataset csm in our example</li>
</ul>
<p>The <strong>kernel</strong> argument is defined by a formula of <strong>Kernel()</strong> objects. In our example, we assume a Gaussian kernel function to fit the joint effect of the conventional features on ratings. By leaving <strong>rho = NULL</strong>, we do not provide any value for the <span class="math inline">\(\rho\)</span> parameter and it will be estimated at the same time as the penalization parameter by minimizing the leave-one-out error. Alternatively, <span class="math inline">\(\rho\)</span> can fixed by the user using the argument <strong>rho=</strong>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">csm.fit1 &lt;-<span class="st"> </span><span class="kw">kspm</span>(<span class="dt">response =</span> <span class="st">&quot;Ratings&quot;</span>, <span class="dt">kernel =</span> <span class="op">~</span><span class="kw">Kernel</span>(<span class="op">~</span>Gross <span class="op">+</span><span class="st"> </span>Budget <span class="op">+</span><span class="st"> </span>Screens <span class="op">+</span><span class="st"> </span>Sequel, <span class="dt">kernel.function =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">rho =</span> <span class="fl">61.22</span>), <span class="dt">data =</span> csm)</a></code></pre></div>
<p>While the model is running, the <strong>kspm()</strong> command prints some indications about the kernel(s) included in the model. Standard functions such as <strong>summary()</strong> can also be used to print results.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">summary</span>(csm.fit1)</a></code></pre></div>
<p>The summary output gives information about the sample size used in the model, the residual distribution, the coefficient for the linear part (similarly to other regression R packages), and the penalization parameter and score test associated with the kernel part. In such a complex model, the number of free parameters, i.e. the standard definition of the degrees of freedom of a model is undefined, and we use instead the effective degrees of freedom of the model, which is not necessary a whole number. However, our definition for effective degrees of freedom is similar to the one used in linear regression models and depends on the trace of the hat matrix.</p>
</div>
<div id="diagnostic-plots" class="section level3">
<h3><span class="header-section-number">2.2.2</span> Diagnostic plots</h3>
<p>The <strong>plot()</strong> command displays standard diagnostic plots for regression models, such as residuals versus fitted values, residuals versus leverage or residuals versus cook’s distance, using the argument <strong>which=</strong>. Note that outliers are anotated.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">plot</span>(csm.fit1, <span class="dt">which =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>), <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">cex =</span> <span class="fl">1.3</span>)</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">hist</span>(csm<span class="op">$</span>Ratings, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">main =</span> <span class="st">&quot;Histogram of Ratings&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;Ratings&quot;</span>)</a></code></pre></div>
<p>Of note, the lower tail of residuals distribution is not as expected under normality. The histogram of ratings shows that could be due to the skewed distribution of the response variable.</p>
</div>
<div id="interpretation-of-coefficients-through-pointwise-derivatives-plots" class="section level3">
<h3><span class="header-section-number">2.2.3</span> Interpretation of coefficients through pointwise derivatives plots</h3>
<p>Like <span class="math inline">\(\beta\)</span> coefficients in linear regression models, the derivative function may help to interpret the effect of each variable individually on the outcome. The <strong>derivatives()</strong> command computes partial derivatives of the estimated kernel function according to each variable included in the kernel. Therefore, it illustrates their individual effects on the outcome at each point of the dataset.</p>
<p>The sign of the derivatives corresponds to the direction of variation of the function capturing the effect of variable on the outcome. The <strong>plot()</strong> command applied to a <strong>derivatives</strong> object gives a graphical interpretation of these effects.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">plot</span>(<span class="kw">derivatives</span>(csm.fit1), <span class="dt">subset =</span> <span class="st">&quot;Gross&quot;</span>, <span class="dt">main =</span> <span class="st">&quot;Pointwise derivatives according to Gross Income&quot;</span>, <span class="dt">cex.main =</span> <span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="kw">plot</span>(<span class="kw">derivatives</span>(csm.fit1), <span class="dt">subset =</span> <span class="st">&quot;Screens&quot;</span>, <span class="dt">col =</span> csm<span class="op">$</span>Sequel, <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">main =</span> <span class="st">&quot;Pointwise derivatives according to </span><span class="ch">\n</span><span class="st"> Number of Screens and Sequel&quot;</span>, <span class="dt">cex.main =</span> <span class="fl">0.8</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.4</span>, <span class="fl">0.8</span>))</a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="dt">fill =</span> <span class="kw">palette</span>()[<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>], <span class="dt">legend =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">7</span>, <span class="dt">title =</span> <span class="st">&quot;Sequel&quot;</span>, <span class="dt">horiz =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">0.7</span>)</a></code></pre></div>
<p>By default, the X-axis label gives the name of the variable and, in brackets, the kernel in which it is included. When only one kernel is included in the kernel, it is named Ker1. Because genre and sequel variables, even if they are numeric, refer to categorical variables, it is possible to easily highlight some pattern of interaction between these variables and other covariates. Derivatives according to Gross income are mostly positive meaning that higher Gross income is associated with higher ratings. However, the slope of this effect decreases as the gross income grows. However it is difficult to interpret the derivatives for Gross income higher than 2.5e+08 since this category includes only a few movies. According to the second graphic, whether a movie has sequels seems to interact with the effect of the number of screens on the ratings. Indeed when the movie is the first or second release (Sequel = 1 or 2), the derivatives are always negative meaning that higher the number of screens on which the movie is projected, lower the ratings, but the effect seems to be stronger for first release than second. No clear pattern can be observed for subsequent sequels. It is difficult to know if this reveals an absence of effect or whether there are simply too few movies past sequel 2 in these data.</p>
</div>
<div id="comparing-choices-of-kernel-function" class="section level3">
<h3><span class="header-section-number">2.2.4</span> Comparing choices of kernel function</h3>
<p>We fit a second model assuming a polynomial kernel function with fixed tuning parameters (<span class="math inline">\(\rho=1\)</span>, <span class="math inline">\(\gamma=1\)</span> and <span class="math inline">\(d=2\)</span>).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">csm.fit2 &lt;-<span class="st"> </span><span class="kw">kspm</span>(<span class="dt">response =</span> <span class="st">&quot;Ratings&quot;</span>, <span class="dt">kernel =</span> <span class="op">~</span><span class="kw">Kernel</span>(<span class="op">~</span>Gross <span class="op">+</span><span class="st"> </span>Budget <span class="op">+</span><span class="st"> </span>Screens <span class="op">+</span><span class="st"> </span>Sequel, <span class="dt">kernel.function =</span> <span class="st">&quot;polynomial&quot;</span>, <span class="dt">rho =</span> <span class="dv">1</span>, <span class="dt">gamma =</span> <span class="dv">1</span>, <span class="dt">d =</span> <span class="dv">2</span>), <span class="dt">data =</span> csm, <span class="dt">level =</span> <span class="dv">0</span>)</a></code></pre></div>
<p>This model can be compared to the previous one using some information criteria such as the AIC or BIC. By default the <strong>extractAIC()</strong> command gives the AIC. A better model is a model with a lower AIC value.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">extractAIC</span>(csm.fit1)</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">extractAIC</span>(csm.fit2)</a></code></pre></div>
</div>
</div>
<div id="predicting-ratings-using-both-conventional-and-social-media-features" class="section level2">
<h2><span class="header-section-number">2.3</span> Predicting ratings using both conventional and social media features</h2>
<p>Of note, in this section <strong>kspm()</strong> function is applied to a multiple kernel semi-parametric model such that it could be time-consuming.</p>
<div id="fitting-the-model-1" class="section level3">
<h3><span class="header-section-number">2.3.1</span> Fitting the model</h3>
<p>Now, we assume a model with three kernel parts, one for conventional features, one for social media features, and the third for their interaction. As for the single kernel case, we use the <strong>kspm()</strong> command. We modify only the <strong>kernel=</strong> argument which becomes a formula of two <strong>Kernel()</strong> objects, one for conventional features and one for social media features. Without interaction, the <strong>Kernel()</strong> objects are separated with “<strong>+</strong>”. In presence of interaction, they are separated with “<strong>:</strong>” (only the interaction) or “<strong><span class="math inline">\(*\)</span></strong>” (interaction and main effects).</p>
<p>Here, we propose to use the gaussian kernel function for each set of features although different kernels could be used. We fixed the tuning parameters the values estimated for each kernel separately. This model includes 2 kernels and their interaction. Thus, three penalization parameters should be estimated. The estimation can take a long time.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">csm.fit3 &lt;-<span class="st"> </span><span class="kw">kspm</span>(<span class="dt">response =</span> <span class="st">&quot;Ratings&quot;</span>, <span class="dt">linear =</span> <span class="ot">NULL</span>, <span class="dt">kernel =</span> <span class="op">~</span><span class="kw">Kernel</span>(<span class="op">~</span><span class="st"> </span>Gross <span class="op">+</span><span class="st"> </span>Budget <span class="op">+</span><span class="st"> </span>Screens <span class="op">+</span><span class="st"> </span>Sequel, <span class="dt">kernel.function =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">rho =</span> <span class="fl">61.22</span>) <span class="op">*</span><span class="st"> </span><span class="kw">Kernel</span>(<span class="op">~</span><span class="st"> </span>Sentiment <span class="op">+</span><span class="st"> </span>Views <span class="op">+</span><span class="st"> </span>Likes <span class="op">+</span><span class="st"> </span>Dislikes <span class="op">+</span><span class="st"> </span>Comments <span class="op">+</span><span class="st"> </span>Aggregate.Followers, <span class="dt">kernel.function =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">rho =</span> <span class="fl">1.562652</span>), <span class="dt">data =</span> csm)</a></code></pre></div>
<p>The model includes three kernels: the kernel of conventional features (<strong>Ker1</strong>), the kernel of social media features (<strong>Ker2</strong>) and their interaction (<strong>Ker1:Ker2</strong>).</p>
<p>The <strong>summary()</strong> command returns the p-value for the test of interaction between Ker1 and Ker2, using the option <strong>kernel.test = “Ker1:Ker2”</strong>. It also returns the p-value for the global test using the option <strong>global.test = TRUE</strong>.</p>
<p>Adding social media features to the model improved the predictions, as indicated by the increased adjusted <span class="math inline">\(R^2\)</span>. However, smooth function associated with the kernel interaction does not significantly differ from the null, leading to the conclusion that there is no interaction effect between conventional and social media features on the ratings.</p>
</div>
<div id="prediction-for-new-data" class="section level3">
<h3><span class="header-section-number">2.3.2</span> Prediction for new data</h3>
<p>Suppose we want to predict the ratings that will be attributed to the three artificial movies described below, according to the model csm.fit3.</p>
<table style="width:100%;">
<colgroup>
<col width="10%"></col>
<col width="10%"></col>
<col width="10%"></col>
<col width="10%"></col>
<col width="10%"></col>
<col width="10%"></col>
<col width="10%"></col>
<col width="10%"></col>
<col width="10%"></col>
<col width="10%"></col>
</colgroup>
<thead>
<tr class="header">
<th>Gross</th>
<th>Budget</th>
<th>Screens</th>
<th>Sequel</th>
<th>Sentiment</th>
<th>Views</th>
<th>Likes</th>
<th>Dislikes</th>
<th>Comments</th>
<th>Aggregate.Followers</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>5.0e+07</td>
<td>1.8e+08</td>
<td>3600</td>
<td>2</td>
<td>1</td>
<td>293021</td>
<td>3698</td>
<td>768</td>
<td>336</td>
<td>4530000</td>
</tr>
<tr class="even">
<td>50000</td>
<td>5.2e+05</td>
<td>210</td>
<td>1</td>
<td>2</td>
<td>7206</td>
<td>2047</td>
<td>49</td>
<td>70</td>
<td>350000</td>
</tr>
<tr class="odd">
<td>10000</td>
<td>1.3e+03</td>
<td>5050</td>
<td>1</td>
<td>10</td>
<td>5692061</td>
<td>5025</td>
<td>305</td>
<td>150</td>
<td>960000</td>
</tr>
</tbody>
</table>
<p>First, we build new data frames for each kernel:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="co"># new data frame for Ker1</span></a>
<a class="sourceLine" id="cb10-2" title="2">newdata.Ker1 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Genre =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">8</span>), <span class="dt">Gross =</span> <span class="kw">c</span>(<span class="fl">5.0e+07</span>, <span class="dv">50000</span>, <span class="dv">10000</span>),<span class="dt">Budget =</span> <span class="kw">c</span>(<span class="fl">1.8e+08</span>, <span class="fl">5.2e+05</span>, <span class="fl">1.3e+03</span>), <span class="dt">Screens =</span> <span class="kw">c</span>(<span class="dv">3600</span>, <span class="dv">210</span>, <span class="dv">5050</span>), <span class="dt">Sequel =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="co"># new data frame for Ker2</span></a>
<a class="sourceLine" id="cb10-5" title="5">newdata.Ker2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Sentiment =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">10</span>), <span class="dt">Views =</span> <span class="kw">c</span>(<span class="dv">293021</span>, <span class="dv">7206</span>, <span class="dv">5692061</span>), <span class="dt">Likes =</span> <span class="kw">c</span>(<span class="dv">3698</span>, <span class="dv">2047</span>, <span class="dv">5025</span>), <span class="dt">Dislikes =</span> <span class="kw">c</span>(<span class="dv">768</span>, <span class="dv">49</span>, <span class="dv">305</span>), <span class="dt">Comments =</span> <span class="kw">c</span>(<span class="dv">336</span>, <span class="dv">70</span>, <span class="dv">150</span>), <span class="dt">Aggregate.Followers =</span> <span class="kw">c</span>(<span class="dv">4530000</span>, <span class="dv">350000</span>, <span class="dv">960000</span>))</a></code></pre></div>
<p>Then, we use the <strong>predict()</strong> command to obtain predictions:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">new.predictions &lt;-<span class="st"> </span><span class="kw">predict</span>(csm.fit3, <span class="dt">newdata.kernel =</span> <span class="kw">list</span>(<span class="dt">Ker1 =</span> newdata.Ker1, <span class="dt">Ker2 =</span> newdata.Ker2), <span class="dt">interval =</span> <span class="st">&quot;prediction&quot;</span>)</a>
<a class="sourceLine" id="cb11-2" title="2">new.predictions</a></code></pre></div>
</div>
<div id="prediction-for-current-data" class="section level3">
<h3><span class="header-section-number">2.3.3</span> Prediction for current data</h3>
<p>We may obtain the predictions (fitted values) for original data directly from the model.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">head</span>(csm.fit3<span class="op">$</span>fitted.value)</a></code></pre></div>
<p>We may obtain the predictions for the original data directly from the model or from the <strong>predict()</strong> function. In the second case, confidence intervals may be additionally obtained.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">pred &lt;-<span class="st"> </span><span class="kw">predict</span>(csm.fit3, <span class="dt">interval =</span> <span class="st">&quot;confidence&quot;</span>)</a>
<a class="sourceLine" id="cb13-2" title="2"><span class="kw">head</span>(pred)</a></code></pre></div>
<p>The following code displays the prediction values against the true values.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">plot</span>(csm<span class="op">$</span>Ratings, pred<span class="op">$</span>fit, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">10</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">10</span>), <span class="dt">xlab =</span> <span class="st">&quot;Observed ratings&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Predicted ratings&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>)</a>
<a class="sourceLine" id="cb14-2" title="2"><span class="kw">abline</span>(<span class="dt">a =</span> <span class="dv">0</span>, <span class="dt">b =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a></code></pre></div>
</div>
</div>
<div id="an-example-of-variables-selection-procedure" class="section level2">
<h2><span class="header-section-number">2.4</span> An example of variables selection procedure</h2>
<p>Of note, in this section <strong>kspm()</strong> function is ask to estimate tuning parameters at the same time than penalisation parameter such that it could be time-consuming.</p>
<p>We assume a single kernel semi-parametric model with a gaussian kernel function. The kernel part contains the set of social media features. We want to select the relevant variables to be included in the kernel. We performed a stepwise variables selection procedure based on AIC, by letting <span class="math inline">\(\rho\)</span> to vary at each iteration. To do so, we first fitted the full model including all features:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="co"># NOT RUN</span></a>
<a class="sourceLine" id="cb15-2" title="2">csm.fit4 &lt;-<span class="st"> </span><span class="kw">kspm</span>(<span class="dt">response =</span> <span class="st">&quot;Ratings&quot;</span>, <span class="dt">linear =</span> <span class="ot">NULL</span>, <span class="dt">kernel =</span> <span class="op">~</span><span class="kw">Kernel</span>(<span class="op">~</span><span class="st"> </span>Sentiment <span class="op">+</span><span class="st"> </span>Views <span class="op">+</span><span class="st"> </span>Likes <span class="op">+</span><span class="st"> </span>Dislikes <span class="op">+</span><span class="st"> </span>Comments <span class="op">+</span><span class="st"> </span>Aggregate.Followers, <span class="dt">kernel.function =</span> <span class="st">&quot;gaussian&quot;</span>), <span class="dt">data =</span> csm, <span class="dt">level =</span> <span class="dv">0</span>, <span class="dt">control =</span> <span class="kw">kspmControl</span>(<span class="dt">parallel =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<p>Then, we apply the <strong>stepKSPM()</strong> command on the full model as follows:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="co"># NOT RUN</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="kw">stepKSPM</span>(csm.fit4, <span class="dt">kernel.lower =</span> <span class="op">~</span><span class="dv">1</span>, <span class="dt">kernel.upper =</span> <span class="op">~</span><span class="st"> </span>Sentiment <span class="op">+</span><span class="st"> </span>Views <span class="op">+</span><span class="st"> </span>Likes <span class="op">+</span><span class="st"> </span>Dislikes <span class="op">+</span><span class="st"> </span>Comments <span class="op">+</span><span class="st"> </span>Aggregate.Followers, <span class="dt">direction =</span> <span class="st">&quot;both&quot;</span>, <span class="dt">k =</span> <span class="dv">2</span>, <span class="dt">kernel.param =</span> <span class="st">&quot;change&quot;</span>, <span class="dt">data =</span> csm)</a></code></pre></div>
<p>The <strong>stepKSPM()</strong> command prints the details of each iteration. At the end, the model excluded the variables <strong>Sentiment</strong> and <strong>Views</strong>.</p>
</div>
</div>
<div id="illustration-2-consumption-of-energy" class="section level1">
<h1><span class="header-section-number">3</span> Illustration 2: consumption of energy</h1>
<p>Our second example is a set of data on energy consumed each hour on Ouessant island (France) from September the 13th, 2015 to October the 4th, 2015. The data set also contains corresponding meteorologic data such as temperature (Celsius degrees), pressure (Pa) and humidity rate (g/m<span class="math inline">\(^3\)</span>). These measures were derived from those that were made publicly available by Electricite de France on <a href="https://iles-ponant-edf-sei.opendatasoft.com" class="uri">https://iles-ponant-edf-sei.opendatasoft.com</a> and Meteo France on <a href="https://www.infoclimat.fr" class="uri">https://www.infoclimat.fr</a>. In total the energy data set contains 504 measurements.</p>
<div id="data-importation-1" class="section level2">
<h2><span class="header-section-number">3.1</span> Data importation</h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">data</span>(<span class="st">&quot;energy&quot;</span>)</a>
<a class="sourceLine" id="cb17-2" title="2"><span class="kw">head</span>(energy)</a></code></pre></div>
<p>These data demonstrate strong periodicity depending on time of day. The following code has been generated to display the data.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">2</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb18-2" title="2"><span class="co"># energy among all the measurements</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="kw">plot</span>(energy<span class="op">$</span>power, <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;Time&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Power&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">xaxt =</span> <span class="st">&quot;n&quot;</span>)</a>
<a class="sourceLine" id="cb18-4" title="4"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at =</span> <span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">0</span><span class="op">:</span><span class="dv">21</span>), <span class="dt">labels =</span> <span class="kw">unique</span>(energy<span class="op">$</span>date))</a>
<a class="sourceLine" id="cb18-5" title="5"><span class="co"># examples from three days</span></a>
<a class="sourceLine" id="cb18-6" title="6"><span class="kw">plot</span>(<span class="kw">c</span>(<span class="ot">NA</span>,energy[<span class="dv">1</span><span class="op">:</span><span class="dv">26</span>, <span class="st">&quot;power&quot;</span>]), <span class="dt">type =</span> <span class="st">&quot;b&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;Time&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Power&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">xaxt =</span> <span class="st">&quot;n&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;darkgreen&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">30</span>))</a>
<a class="sourceLine" id="cb18-7" title="7"><span class="kw">lines</span>(energy[<span class="dv">24</span><span class="op">:</span><span class="dv">50</span>, <span class="st">&quot;power&quot;</span>], <span class="dt">type =</span> <span class="st">&quot;b&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>, <span class="dt">pch =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb18-8" title="8"><span class="kw">lines</span>(energy[<span class="dv">48</span><span class="op">:</span><span class="dv">74</span>, <span class="st">&quot;power&quot;</span>], <span class="dt">type =</span> <span class="st">&quot;b&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb18-9" title="9"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">7</span>, <span class="dv">13</span>, <span class="dv">19</span>, <span class="dv">25</span>), <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;0h00&quot;</span>, <span class="st">&quot;6h00&quot;</span>, <span class="st">&quot;12h00&quot;</span>, <span class="st">&quot;18h00&quot;</span>, <span class="st">&quot;0h00&quot;</span>))</a>
<a class="sourceLine" id="cb18-10" title="10"><span class="kw">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;darkgreen&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;red&quot;</span>), <span class="dt">legend =</span> <span class="kw">c</span>(<span class="st">&quot;Sep 13, 2015&quot;</span>, <span class="st">&quot;Sep 14, 2015&quot;</span>, <span class="st">&quot;Sep 15, 2015&quot;</span>), <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">pch =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">17</span>))</a>
<a class="sourceLine" id="cb18-11" title="11"><span class="kw">abline</span>(<span class="dt">v =</span> <span class="fl">24.9</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb18-12" title="12"><span class="kw">text</span>(<span class="fl">25.5</span>, <span class="dv">730</span>, <span class="st">&quot;next day&quot;</span>, <span class="dt">adj =</span> <span class="dv">0</span>)</a></code></pre></div>
<p>To predict the energy consumption, we will consider the 408 first measurements (17 days) as the training set. The other 96 days will be used as a test set.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">energy_train_ &lt;-<span class="st"> </span>energy[<span class="dv">1</span><span class="op">:</span><span class="dv">408</span>, ]</a>
<a class="sourceLine" id="cb19-2" title="2">energy_test_ &lt;-<span class="st"> </span>energy[<span class="dv">409</span><span class="op">:</span><span class="dv">504</span>, ]</a></code></pre></div>
</div>
<div id="a-first-model" class="section level2">
<h2><span class="header-section-number">3.2</span> A first model</h2>
<p>We fit a single kernel semi-parametric model to the training data. We assumed that energy depends linearly on temperature, and therefore this variable is included in the linear part of the model. The other meteorologic data as well as hours in 24-hour numeric format are included in the kernel part of the model. We used a gaussian kernel.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">energy.fit1 &lt;-<span class="st"> </span><span class="kw">kspm</span>(<span class="dt">response =</span> <span class="st">&quot;power&quot;</span>, <span class="dt">linear =</span> <span class="op">~</span>Temperature, <span class="dt">kernel =</span> <span class="op">~</span><span class="kw">Kernel</span>(<span class="op">~</span>hour.num <span class="op">+</span><span class="st"> </span>P <span class="op">+</span><span class="st"> </span>HR, <span class="dt">kernel.function =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">rho =</span> <span class="fl">0.7</span>) , <span class="dt">data =</span> energy_train_)</a></code></pre></div>
</div>
<div id="impact-of-the-tuning-parameter-rho-on-predictions-and-derivatives" class="section level2">
<h2><span class="header-section-number">3.3</span> Impact of the tuning parameter <span class="math inline">\(\rho\)</span> on predictions and derivatives</h2>
<p>We recomputed the model with different values of the tuning parameter <span class="math inline">\(\rho\)</span> to explore sensitivity of the results to this key kernel paramater. The actual value is:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">energy.fit1<span class="op">$</span>kernel.info<span class="op">$</span>Ker1<span class="op">$</span>rho</a></code></pre></div>
<p>Other values were chosen ten fold smaller and larger than the estimated value of <span class="math inline">\(0.70\)</span>.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">energy.fit2 &lt;-<span class="st"> </span><span class="kw">kspm</span>(<span class="dt">response =</span> <span class="st">&quot;power&quot;</span>, <span class="dt">linear =</span> <span class="op">~</span>Temperature, <span class="dt">kernel =</span> <span class="op">~</span><span class="kw">Kernel</span>(<span class="op">~</span>hour.num <span class="op">+</span><span class="st"> </span>P <span class="op">+</span><span class="st"> </span>HR, <span class="dt">kernel.function =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">rho =</span> <span class="fl">0.07</span>) , <span class="dt">data =</span> energy_train_, <span class="dt">level =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb22-2" title="2">energy.fit3 &lt;-<span class="st"> </span><span class="kw">kspm</span>(<span class="dt">response =</span> <span class="st">&quot;power&quot;</span>, <span class="dt">linear =</span> <span class="op">~</span>Temperature, <span class="dt">kernel =</span> <span class="op">~</span><span class="kw">Kernel</span>(<span class="op">~</span>hour.num <span class="op">+</span><span class="st"> </span>P <span class="op">+</span><span class="st"> </span>HR, <span class="dt">kernel.function =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">rho =</span> <span class="dv">7</span>) , <span class="dt">data =</span> energy_train_, <span class="dt">level =</span> <span class="dv">0</span>)</a></code></pre></div>
<p>We display the predictions obtained on both the training and test data sets, as well as the derivatives, as a function of the hours variable,for the three models <strong>energy.fit1</strong>, <strong>energy.fit2</strong> and <strong>energy.fit3</strong> that differ only on the value of the tuning parameter <span class="math inline">\(\rho\)</span>.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="co">### parameters for figures panel</span></a>
<a class="sourceLine" id="cb23-2" title="2"><span class="kw">par</span>(<span class="dt">oma =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb23-3" title="3"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb23-4" title="4"></a>
<a class="sourceLine" id="cb23-5" title="5"><span class="co">### kspm.fit1 (rho = 0.7)</span></a>
<a class="sourceLine" id="cb23-6" title="6"><span class="co"># predictions with confidence intervals on train_</span></a>
<a class="sourceLine" id="cb23-7" title="7"><span class="kw">plot</span>(energy_train_[<span class="dv">1</span><span class="op">:</span><span class="dv">72</span>, <span class="st">&quot;power&quot;</span>], <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;Time&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Power&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">xaxt =</span> <span class="st">&quot;n&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">300</span>, <span class="dv">750</span>))</a>
<a class="sourceLine" id="cb23-8" title="8"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at =</span> <span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">0</span><span class="op">:</span><span class="dv">2</span>), <span class="dt">labels =</span> <span class="kw">unique</span>(energy_train_<span class="op">$</span>date)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a>
<a class="sourceLine" id="cb23-9" title="9">pred_train_ &lt;-<span class="st"> </span><span class="kw">predict</span>(energy.fit1, <span class="dt">interval =</span> <span class="st">&quot;confidence&quot;</span>)</a>
<a class="sourceLine" id="cb23-10" title="10"><span class="kw">lines</span>(pred_train_<span class="op">$</span>fit, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</a>
<a class="sourceLine" id="cb23-11" title="11"><span class="kw">lines</span>(pred_train_<span class="op">$</span>lwr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-12" title="12"><span class="kw">lines</span>(pred_train_<span class="op">$</span>upr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-13" title="13"><span class="co"># predictions with prediction intervals on test_</span></a>
<a class="sourceLine" id="cb23-14" title="14"><span class="kw">plot</span>(energy_test_[<span class="dv">1</span><span class="op">:</span><span class="dv">72</span>, <span class="st">&quot;power&quot;</span>], <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;Time&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Power&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">xaxt =</span> <span class="st">&quot;n&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">300</span>, <span class="dv">750</span>))</a>
<a class="sourceLine" id="cb23-15" title="15"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at =</span> <span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">0</span><span class="op">:</span><span class="dv">2</span>), <span class="dt">labels =</span> <span class="kw">unique</span>(energy_test_<span class="op">$</span>date)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a>
<a class="sourceLine" id="cb23-16" title="16">pred_train_ &lt;-<span class="st"> </span><span class="kw">predict</span>(energy.fit1, <span class="dt">newdata.linear =</span>  energy_test_, <span class="dt">newdata.kernel =</span> <span class="kw">list</span>(<span class="dt">Ker1 =</span> energy_test_), <span class="dt">interval =</span> <span class="st">&quot;prediction&quot;</span>)</a>
<a class="sourceLine" id="cb23-17" title="17"><span class="kw">lines</span>(pred_train_<span class="op">$</span>fit, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</a>
<a class="sourceLine" id="cb23-18" title="18"><span class="kw">lines</span>(pred_train_<span class="op">$</span>lwr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-19" title="19"><span class="kw">lines</span>(pred_train_<span class="op">$</span>upr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-20" title="20"><span class="co"># derivatives</span></a>
<a class="sourceLine" id="cb23-21" title="21"><span class="kw">plot</span>(<span class="kw">derivatives</span>(energy.fit1), <span class="dt">subset =</span> <span class="st">&quot;hour.num&quot;</span>, <span class="dt">xaxt =</span> <span class="st">&quot;n&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Derivatives&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1000</span>,<span class="dv">1000</span>))</a>
<a class="sourceLine" id="cb23-22" title="22"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">18</span>), <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;0h00&quot;</span>, <span class="st">&quot;6h00&quot;</span>, <span class="st">&quot;12h00&quot;</span>, <span class="st">&quot;18h00&quot;</span>))</a>
<a class="sourceLine" id="cb23-23" title="23"></a>
<a class="sourceLine" id="cb23-24" title="24"><span class="co">### kspm.fit3 (rho = 0.07)</span></a>
<a class="sourceLine" id="cb23-25" title="25"><span class="co"># predictions with confidence intervals on train_</span></a>
<a class="sourceLine" id="cb23-26" title="26"><span class="kw">plot</span>(energy_train_[<span class="dv">1</span><span class="op">:</span><span class="dv">72</span>, <span class="st">&quot;power&quot;</span>], <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;Time&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Power&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">xaxt =</span> <span class="st">&quot;n&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">300</span>, <span class="dv">750</span>))</a>
<a class="sourceLine" id="cb23-27" title="27"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at =</span> <span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">0</span><span class="op">:</span><span class="dv">2</span>), <span class="dt">labels =</span> <span class="kw">unique</span>(energy_train_<span class="op">$</span>date)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a>
<a class="sourceLine" id="cb23-28" title="28">pred_train_ &lt;-<span class="st"> </span><span class="kw">predict</span>(energy.fit2, <span class="dt">interval =</span> <span class="st">&quot;confidence&quot;</span>)</a>
<a class="sourceLine" id="cb23-29" title="29"><span class="kw">lines</span>(pred_train_<span class="op">$</span>fit, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</a>
<a class="sourceLine" id="cb23-30" title="30"><span class="kw">lines</span>(pred_train_<span class="op">$</span>lwr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-31" title="31"><span class="kw">lines</span>(pred_train_<span class="op">$</span>upr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-32" title="32"><span class="co"># predictions with prediction intervals on test_</span></a>
<a class="sourceLine" id="cb23-33" title="33"><span class="kw">plot</span>(energy_test_[<span class="dv">1</span><span class="op">:</span><span class="dv">72</span>, <span class="st">&quot;power&quot;</span>], <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;Time&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Power&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">xaxt =</span> <span class="st">&quot;n&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">300</span>, <span class="dv">750</span>))</a>
<a class="sourceLine" id="cb23-34" title="34"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at =</span> <span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">0</span><span class="op">:</span><span class="dv">2</span>), <span class="dt">labels =</span> <span class="kw">unique</span>(energy_test_<span class="op">$</span>date)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a>
<a class="sourceLine" id="cb23-35" title="35">pred_train_ &lt;-<span class="st"> </span><span class="kw">predict</span>(energy.fit2, <span class="dt">newdata.linear =</span>  energy_test_, <span class="dt">newdata.kernel =</span> <span class="kw">list</span>(<span class="dt">Ker1 =</span> energy_test_), <span class="dt">interval =</span> <span class="st">&quot;prediction&quot;</span>)</a>
<a class="sourceLine" id="cb23-36" title="36"><span class="kw">lines</span>(pred_train_<span class="op">$</span>fit, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</a>
<a class="sourceLine" id="cb23-37" title="37"><span class="kw">lines</span>(pred_train_<span class="op">$</span>lwr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-38" title="38"><span class="kw">lines</span>(pred_train_<span class="op">$</span>upr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-39" title="39"><span class="co"># derivatives</span></a>
<a class="sourceLine" id="cb23-40" title="40"><span class="kw">plot</span>(<span class="kw">derivatives</span>(energy.fit2), <span class="dt">subset =</span> <span class="st">&quot;hour.num&quot;</span>, <span class="dt">xaxt =</span> <span class="st">&quot;n&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Derivatives&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1000</span>,<span class="dv">1000</span>))</a>
<a class="sourceLine" id="cb23-41" title="41"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">18</span>), <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;0h00&quot;</span>, <span class="st">&quot;6h00&quot;</span>, <span class="st">&quot;12h00&quot;</span>, <span class="st">&quot;18h00&quot;</span>))</a>
<a class="sourceLine" id="cb23-42" title="42"></a>
<a class="sourceLine" id="cb23-43" title="43"><span class="co">### kspm.fit2 (rho = 7)</span></a>
<a class="sourceLine" id="cb23-44" title="44"><span class="co"># predictions with confidence intervals on train_</span></a>
<a class="sourceLine" id="cb23-45" title="45"><span class="kw">plot</span>(energy_train_[<span class="dv">1</span><span class="op">:</span><span class="dv">72</span>, <span class="st">&quot;power&quot;</span>], <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;Time&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Power&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">xaxt =</span> <span class="st">&quot;n&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">300</span>, <span class="dv">750</span>))</a>
<a class="sourceLine" id="cb23-46" title="46"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at =</span> <span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">0</span><span class="op">:</span><span class="dv">2</span>), <span class="dt">labels =</span> <span class="kw">unique</span>(energy_train_<span class="op">$</span>date)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a>
<a class="sourceLine" id="cb23-47" title="47">pred_train_ &lt;-<span class="st"> </span><span class="kw">predict</span>(energy.fit3, <span class="dt">interval =</span> <span class="st">&quot;confidence&quot;</span>)</a>
<a class="sourceLine" id="cb23-48" title="48"><span class="kw">lines</span>(pred_train_<span class="op">$</span>fit, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</a>
<a class="sourceLine" id="cb23-49" title="49"><span class="kw">lines</span>(pred_train_<span class="op">$</span>lwr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-50" title="50"><span class="kw">lines</span>(pred_train_<span class="op">$</span>upr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-51" title="51"><span class="co"># predictions with prediction intervals on test_</span></a>
<a class="sourceLine" id="cb23-52" title="52"><span class="kw">plot</span>(energy_test_[<span class="dv">1</span><span class="op">:</span><span class="dv">72</span>, <span class="st">&quot;power&quot;</span>], <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;Time&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Power&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">xaxt =</span> <span class="st">&quot;n&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">300</span>, <span class="dv">750</span>))</a>
<a class="sourceLine" id="cb23-53" title="53"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at =</span> <span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">0</span><span class="op">:</span><span class="dv">2</span>), <span class="dt">labels =</span> <span class="kw">unique</span>(energy_test_<span class="op">$</span>date)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a>
<a class="sourceLine" id="cb23-54" title="54">pred_train_ &lt;-<span class="st"> </span><span class="kw">predict</span>(energy.fit3, <span class="dt">newdata.linear =</span>  energy_test_, <span class="dt">newdata.kernel =</span> <span class="kw">list</span>(<span class="dt">Ker1 =</span> energy_test_), <span class="dt">interval =</span> <span class="st">&quot;prediction&quot;</span>)</a>
<a class="sourceLine" id="cb23-55" title="55"><span class="kw">lines</span>(pred_train_<span class="op">$</span>fit, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</a>
<a class="sourceLine" id="cb23-56" title="56"><span class="kw">lines</span>(pred_train_<span class="op">$</span>lwr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-57" title="57"><span class="kw">lines</span>(pred_train_<span class="op">$</span>upr, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-58" title="58"><span class="co"># derivatives</span></a>
<a class="sourceLine" id="cb23-59" title="59"><span class="kw">plot</span>(<span class="kw">derivatives</span>(energy.fit3), <span class="dt">subset =</span> <span class="st">&quot;hour.num&quot;</span>, <span class="dt">xaxt =</span> <span class="st">&quot;n&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Derivatives&quot;</span>, <span class="dt">cex.lab =</span> <span class="fl">1.5</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1000</span>,<span class="dv">1000</span>))</a>
<a class="sourceLine" id="cb23-60" title="60"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">at =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">18</span>), <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;0h00&quot;</span>, <span class="st">&quot;6h00&quot;</span>, <span class="st">&quot;12h00&quot;</span>, <span class="st">&quot;18h00&quot;</span>))</a>
<a class="sourceLine" id="cb23-61" title="61"></a>
<a class="sourceLine" id="cb23-62" title="62"><span class="co"># Legends</span></a>
<a class="sourceLine" id="cb23-63" title="63"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb23-64" title="64"><span class="kw">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="dt">lty =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>), <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="dt">legend =</span> <span class="kw">c</span>(<span class="st">&quot;True data&quot;</span>, <span class="st">&quot;Predictions&quot;</span>, <span class="st">&quot;Confidence intervals&quot;</span>), <span class="dt">cex =</span> <span class="dv">2</span>, <span class="dt">bty =</span> <span class="st">&quot;n&quot;</span>)</a>
<a class="sourceLine" id="cb23-65" title="65"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb23-66" title="66"><span class="kw">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="dt">lty =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>), <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="dt">legend =</span> <span class="kw">c</span>(<span class="st">&quot;True data&quot;</span>, <span class="st">&quot;Predictions&quot;</span>, <span class="st">&quot;Prediction intervals&quot;</span>), <span class="dt">cex =</span> <span class="dv">2</span>,  <span class="dt">bty =</span> <span class="st">&quot;n&quot;</span>)</a>
<a class="sourceLine" id="cb23-67" title="67"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb23-68" title="68"><span class="kw">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="dt">pch =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;black&quot;</span>), <span class="dt">legend =</span> <span class="kw">c</span>(<span class="st">&quot;Pointwise derivatives </span><span class="ch">\n</span><span class="st"> 1 point = 1 measure&quot;</span>), <span class="dt">cex =</span> <span class="dv">2</span>, <span class="dt">bty =</span> <span class="st">&quot;n&quot;</span>)</a>
<a class="sourceLine" id="cb23-69" title="69"></a>
<a class="sourceLine" id="cb23-70" title="70"></a>
<a class="sourceLine" id="cb23-71" title="71"><span class="co">### legends on the left</span></a>
<a class="sourceLine" id="cb23-72" title="72"><span class="kw">par</span>(<span class="dt">fig =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">0.05</span>,<span class="dv">0</span>,<span class="fl">0.25</span>), <span class="dt">oma =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="dt">new =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-73" title="73"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb23-74" title="74"><span class="kw">text</span>(<span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="st">&quot;Legend&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">cex =</span> <span class="dv">2</span>, <span class="dt">adj =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb23-75" title="75"><span class="kw">par</span>(<span class="dt">fig =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">0.05</span>,<span class="fl">0.26</span>,<span class="fl">0.5</span>), <span class="dt">oma =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="dt">new =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-76" title="76"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb23-77" title="77"><span class="kw">text</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="kw">expression</span>(<span class="kw">paste</span>(rho, <span class="st">&quot; = 7&quot;</span>)), <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">cex =</span> <span class="dv">2</span>, <span class="dt">adj =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb23-78" title="78"><span class="kw">par</span>(<span class="dt">fig =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">0.05</span>,<span class="fl">0.5</span>,<span class="fl">0.72</span>), <span class="dt">oma =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="dt">new =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-79" title="79"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb23-80" title="80"><span class="kw">text</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="kw">expression</span>(<span class="kw">paste</span>(rho, <span class="st">&quot; = 0.07&quot;</span>)), <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">cex =</span> <span class="dv">2</span>, <span class="dt">adj =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb23-81" title="81"><span class="kw">par</span>(<span class="dt">fig =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">0.05</span>,<span class="fl">0.72</span>,<span class="fl">0.97</span>), <span class="dt">oma =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="dt">new =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-82" title="82"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb23-83" title="83"><span class="kw">text</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="kw">expression</span>(<span class="kw">paste</span>(rho, <span class="st">&quot; = 0.7&quot;</span>)), <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">cex =</span> <span class="dv">2</span>, <span class="dt">adj =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb23-84" title="84"></a>
<a class="sourceLine" id="cb23-85" title="85"><span class="co">### legends on the top</span></a>
<a class="sourceLine" id="cb23-86" title="86"><span class="kw">par</span>(<span class="dt">fig =</span> <span class="kw">c</span>(<span class="fl">0.05</span>,<span class="fl">0.36</span>,<span class="fl">0.92</span>,<span class="dv">1</span>), <span class="dt">oma =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="dt">new =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-87" title="87"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb23-88" title="88"><span class="kw">text</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">&quot;Predictions on training data set&quot;</span>,  <span class="dt">cex =</span> <span class="dv">2</span>, <span class="dt">adj =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb23-89" title="89"><span class="kw">par</span>(<span class="dt">fig =</span> <span class="kw">c</span>(<span class="fl">0.37</span>,<span class="fl">0.68</span>,<span class="fl">0.92</span>,<span class="dv">1</span>), <span class="dt">oma =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="dt">new =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-90" title="90"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb23-91" title="91"><span class="kw">text</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">&quot;Predictions on test data set&quot;</span>,  <span class="dt">cex =</span> <span class="dv">2</span>, <span class="dt">adj =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb23-92" title="92"><span class="kw">par</span>(<span class="dt">fig =</span> <span class="kw">c</span>(<span class="fl">0.69</span>,<span class="dv">1</span>,<span class="fl">0.92</span>,<span class="dv">1</span>), <span class="dt">oma =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="dt">new =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-93" title="93"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb23-94" title="94"><span class="kw">text</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">&quot;Derivatives for hour.num&quot;</span>,  <span class="dt">cex =</span> <span class="dv">2</span>, <span class="dt">adj =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<p>The first row corresponds to the model with the value of <span class="math inline">\(\rho\)</span> estimated by the model. Predictions fit well for both the training and the test sets. The derivative graph shows that between 6h00 and 12h00 and between 18h00 and 23h00 the derivatives are positive. It is coherent with the increase of energy consumption during these times of the day. Inversely, between 0h00 and 6h00 and between 12h00 and 18h00, the energy consumption decreases as showed by negative values of derivatives. One might have expected that derivative values should be close between 0h00 and 23h00 but the consumption peak observed at 23h00 everyday may explain a sudden change in derivative values that is difficult to smooth.</p>
</div>
</div>
<div id="references" class="section level1">
<h1><span class="header-section-number">4</span> References</h1>
<p>Ahmed M, Jahangir M, Afzal H, Majeed A, Siddiqi I (2015). “Using Crowd-Source Based Features from Social Media and Conventional Features to Predict the Movies Popularity.” In <em>IEEE International Conference on Smart City/SocialCom/SustainCom (SmartCity)</em>, pp 273-278. IEEE.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
